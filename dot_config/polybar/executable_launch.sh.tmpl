#!/bin/bash

# Убить все polybar-процессы
killall -q polybar

# Подождать на всякий
while pgrep -u "$UID" -x polybar >/dev/null; do sleep 1; done

# Функция: вернуть монитор, отмеченный как primary, иначе первый в списке
detect_primary() {
    primary=$(xrandr --query | awk '/ connected/ && /primary/ {print $1; exit}')
    [ -z "$primary" ] && primary=$(xrandr --query | awk '/ connected/ {print $1; exit}')
    echo "$primary"
}

# Собираем все подключённые мониторы
mapfile -t monitors < <(xrandr --query | awk '/ connected/ {print $1}')
count=${#monitors[@]}

primary=$(detect_primary)

if (( count <= 1 )); then
    # Один монитор — просто запускаем единый конфиг
    MONITOR="${monitors[0]}" polybar -c ~/.config/polybar/config.ini example &
else
    # Несколько: основной получает primary-конфиг, остальные — secondary
    for mon in "${monitors[@]}"; do
        if [ "$mon" = "$primary" ]; then
            MONITOR="$mon" polybar -c ~/.config/polybar/config-primary example &
        else
            MONITOR="$mon" polybar -c ~/.config/polybar/config-secondary example &
        fi
    done
fi
