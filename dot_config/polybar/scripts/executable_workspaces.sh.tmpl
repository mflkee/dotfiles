#!/bin/bash

# Наборы иконок (расширенные для поддержки до 20 рабочих столов)
icons_empty=(󰎦 󰎩 󰎬 󰎮 󰎰 󰎵 󰎸 󰎻 󰎾 󰽾 󱍻 󰭤 )
icons_single=(󰎤 󰎧 󰎪 󰎭 󰎱 󰎳 󰎶 󰎹 󰎼 󰽽 󰃁 󰂿 )
icons_multi=(󰼏 󰼐 󰼑 󰼒 󰼓 󰼔 󰼕 󰼖 󰼗 󰿪 󰸕 󰂻 )

# Цвета
color_empty="#949494"
color_single="#E3C78A"
color_multi="#CF87E8"
color_focused="#8CC85F"
underline_color="#79DAC8"

# Размер шрифта
font_size="%{T13}"

# Определяем монитор всегда через bspc, игнорируя ENV
current_monitor=$(bspc query -M -m focused --names)

# Все десктопы этого монитора
workspaces=($(bspc query -D -m "$current_monitor" --names))

output=""
focused_ws=$(bspc query -D -d focused --names)

# Проходимся по порядку, i — индекс в массиве = номер значка
for i in "${!workspaces[@]}"; do
    ws="${workspaces[$i]}"
    windows=$(bspc query -N -d "$ws")

    # Выбираем подходящий икон/цвет
    if [ -z "$windows" ]; then
        icon="${icons_empty[$i]}"
        color=$color_empty
    else
        count=$(wc -l <<<"$windows")
        if [ "$count" -eq 1 ]; then
            icon="${icons_single[$i]}"
            color=$color_single
        else
            icon="${icons_multi[$i]}"
            color=$color_multi
        fi
    fi

    # Если фокус на этом десктопе — подчёркиваем и перекрашиваем
    if [ "$ws" = "$focused_ws" ]; then
        output+="%{A1:bspc desktop -f $ws:}%{F$color_focused}%{u$underline_color}%{+u}${font_size}${icon}%{-u}%{F-}%{A} "
    else
        output+="%{A1:bspc desktop -f $ws:}%{F$color}${font_size}${icon}%{F-}%{A} "
    fi
done

echo "$output"
