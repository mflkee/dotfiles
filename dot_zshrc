#!/usr/bin/env zsh
# ================================================================
# .zshrc - Конфигурация Zsh с использованием Zinit и Oh My Zsh
# ================================================================
# Описание:
#  • Инициализирует Zinit для управления плагинами.
#  • Загружает плагины и библиотеки Oh My Zsh, необходимые для корректной работы.
#  • Устанавливает заглушки для функций, если некоторые скрипты не загружаются.
#  • Подключает пользовательские алиасы, функции и настройки окружения.
# ================================================================

# --------------------
# Zinit Plugin Manager
# --------------------
if [[ ! -f ~/.config/zsh/plugins/zinit/zinit.zsh ]]; then
  git clone https://github.com/zdharma-continuum/zinit.git ~/.config/zsh/plugins/zinit
fi
source ~/.config/zsh/plugins/zinit/zinit.zsh
autoload -Uz _zinit
(( ${+_comps} )) && _comps[zinit]=_zinit

# --------------------
# Инициализация автодополнений
# --------------------
autoload -Uz compinit && compinit -u

# --------------------
# Заглушки для функций Oh My Zsh
# --------------------
if ! type _omz_register_handler >/dev/null 2>&1; then
  _omz_register_handler() { :; }
fi

if ! type svn_prompt_info >/dev/null 2>&1; then
  svn_prompt_info() { :; }
fi

# --------------------
# Загрузка основных компонентов Oh My Zsh
# --------------------
# Примечание: Загрузка OMZ::lib/async.zsh пропущена, так как URL вернул 404.
zinit snippet OMZ::lib/git.zsh
zinit snippet OMZ::lib/theme-and-appearance.zsh
zinit snippet OMZ::plugins/git/git.plugin.zsh

# --------------------
# Загрузка дополнительных плагинов
# --------------------
zinit light zdharma-continuum/fast-syntax-highlighting
zinit light zsh-users/zsh-autosuggestions
zinit light agkozak/zsh-z
zinit light MichaelAquilina/zsh-you-should-use

# --------------------
# Основные настройки Zsh
# --------------------
HISTFILE=~/.zsh_history
HISTSIZE=10000
SAVEHIST=10000
setopt appendhistory

bindkey -e
bindkey '^[[3~' delete-char

# --------------------
# Загрузка пользовательских конфигураций
# --------------------
# Загружаем алиасы без вывода сообщений
for file in ~/.config/zsh/aliases/*.zsh; do
  source "$file"
done

# Загружаем функции без вывода сообщений
for file in ~/.config/zsh/functions/*.zsh; do
  source "$file"
done

if [[ -f ~/.config/zsh/venv_manager.zsh ]]; then
  source ~/.config/zsh/venv_manager.zsh
fi

# --------------------
# Переменные окружения
# --------------------
export PATH="$HOME/.local/bin:$PATH"
export EDITOR="nvim"
export MANPAGER="nvim +Man!"
export XDG_CONFIG_HOME="$HOME/.config"

export LUA_PATH="$HOME/.luarocks/share/lua/5.4/?.lua;$HOME/.luarocks/share/lua/5.4/?/init.lua;;"
export LUA_CPATH="$HOME/.luarocks/lib/lua/5.4/?.so;;"
export PYTHONSTARTUP="$HOME/.config/python/pythonrc.py"

# --------------------
# Настройки приложений
# --------------------
export XSECURELOCK_AUTH=auth_x11
export XSECURELOCK_AUTHPROTO=authproto_pam
export XSECURELOCK_SHOW_DATETIME=1
export XSECURELOCK_PASSWORD_PROMPT=emoji
export XSECURELOCK_BACKGROUND_COLOR="#000000"
export XSECURELOCK_AUTH_BACKGROUND_COLOR="#000000"
export XSECURELOCK_AUTH_FOREGROUND_COLOR="#FFFFFF"
export XSECURELOCK_DIM_COLOR="#000000"
export XSECURELOCK_DIM_ALPHA=0.5
export XSECURELOCK_DIM_FPS=60

# --------------------
# Сторонние инструменты
# --------------------
eval "$(zoxide init zsh --cmd cd)"
alias csync="chezmoi apply && chezmoi cd && git add . && git commit -m 'Update config' && git push"
[ -f "$HOME/.local/bin/env" ] && source "$HOME/.local/bin/env"

export PATH="$HOME/.local/bin:$PATH"
# --------------------
# Финальная инициализация
# --------------------
zinit cdreplay -q
zinit snippet OMZ::themes/ys.zsh-theme
# При необходимости можно принудительно активировать тему:
# autoload -U promptinit && promptinit
# prompt ys

# ================================================================
# Конец файла .zshrc
# ================================================================
