#!/usr/bin/env zsh
# ================================================================
# .zshrc - Конфигурация Zsh с использованием Zinit и Oh My Zsh + Starship
# ================================================================
# Описание:
#  • Инициализирует Zinit для управления плагинами.
#  • Загружает плагины и библиотеки Oh My Zsh, необходимые для корректной работы.
#  • Устанавливает заглушки для функций, если некоторые скрипты не загружаются.
#  • Подключает пользовательские алиасы, функции и настройки окружения.
#  • Инициализирует Starship prompt как замену теме Oh My Zsh.
# ================================================================

# --------------------
# Zinit Plugin Manager
# --------------------
if [[ ! -f ~/.config/zsh/plugins/zinit/zinit.zsh ]]; then
  git clone https://github.com/zdharma-continuum/zinit.git ~/.config/zsh/plugins/zinit
fi
source ~/.config/zsh/plugins/zinit/zinit.zsh
autoload -Uz _zinit
(( ${+_comps} )) && _comps[zinit]=_zinit

# --------------------
# Инициализация автодополнений
# --------------------
autoload -Uz compinit && compinit -u

# fzf-tab settings
zstyle ':completion:*' fzf-preview 'bat --style=numbers --color=always --line-range :500 {} 2>/dev/null || tree -C {} | head -100'
zstyle ':fzf-tab:*' switch-group ','  # Ctrl+comma переключение группы
zstyle ':fzf-tab:*' fzf-flags --height=40% --reverse --inline-info
zstyle ':completion:*' menu select

# --------------------
# Заглушки для функций Oh My Zsh
# --------------------
if ! type _omz_register_handler >/dev/null 2>&1; then
  _omz_register_handler() { :; }
fi

if ! type svn_prompt_info >/dev/null 2>&1; then
  svn_prompt_info() { :; }
fi

# --------------------
# Загрузка основных компонентов Oh My Zsh
# --------------------
# Примечание: Загрузка OMZ::lib/async.zsh пропущена, так как URL вернул 404.
zinit snippet OMZ::lib/git.zsh
zinit snippet OMZ::lib/theme-and-appearance.zsh
zinit snippet OMZ::plugins/git/git.plugin.zsh

# --------------------
# Загрузка дополнительных плагинов
# --------------------
zinit light zdharma-continuum/fast-syntax-highlighting
zinit light zsh-users/zsh-autosuggestions
zinit light agkozak/zsh-z
zinit light MichaelAquilina/zsh-you-should-use
zinit light Aloxaf/fzf-tab
zinit light jeffreytse/zsh-vi-mode
zinit light hlissner/zsh-autopair

# --------------------
# Основные настройки Zsh
# --------------------

HISTFILE=~/.zsh_history
HISTSIZE=10000
SAVEHIST=10000
setopt appendhistory

bindkey -e
bindkey '^[[3~' delete-char

# --------------------
# Загрузка пользовательских конфигураций
# --------------------
for file in ~/.config/zsh/aliases/*.zsh; do
  source "$file"
done

for file in ~/.config/zsh/functions/*.zsh; do
  source "$file"
done

if [[ -f ~/.config/zsh/venv_manager.zsh ]]; then
  source ~/.config/zsh/venv_manager.zsh
fi

# --------------------
# Переменные окружения
# --------------------
export PATH="$HOME/.local/bin:$HOME/.npm-global/bin:$PATH"
export EDITOR="nvim"
export MANPAGER="nvim +Man!"
export XDG_CONFIG_HOME="$HOME/.config"
export BROWSER=firefox

# Rust
source "$HOME/.cargo/env"

# Lua
export LUA_PATH="$HOME/.luarocks/share/lua/5.4/?.lua;$HOME/.luarocks/share/lua/5.4/?/init.lua;;"
export LUA_CPATH="$HOME/.luarocks/lib/lua/5.4/?.so;;"

# Python
export PYTHONSTARTUP="$HOME/.config/python/pythonrc.py"
export PYTHONPYCACHEPREFIX="$HOME/.cache/python/__pycache__"  # Для организации pycache

#plantuml
export PLANTUML_INCLUDE_PATH="$HOME/.config/plantuml/config.puml"

# Дополнительные пути
export PATH="$HOME/bin:$PATH"  # Пользовательские бинарники
export PATH="/home/mflkee/.cache/yay/quarto-cli/src/quarto-1.6.42/bin:$PATH"
# --------------------
# Настройки приложений
# --------------------
export XSECURELOCK_AUTH=auth_x11
export XSECURELOCK_AUTHPROTO=authproto_pam
export XSECURELOCK_SHOW_DATETIME=1
export XSECURELOCK_PASSWORD_PROMPT=emoji
export XSECURELOCK_BACKGROUND_COLOR="#000000"
export XSECURELOCK_AUTH_BACKGROUND_COLOR="#000000"
export XSECURELOCK_AUTH_FOREGROUND_COLOR="#FFFFFF"
export XSECURELOCK_DIM_COLOR="#000000"
export XSECURELOCK_DIM_ALPHA=0.5
export XSECURELOCK_DIM_FPS=60

# --------------------
# Сторонние инструменты
# --------------------
eval "$(zoxide init zsh --cmd cd)"

function zoxide-fzf() {
  local dir
  dir=$(zoxide query -l | fzf --height 40% --reverse --preview 'tree -C {} | head -n 50')
  if [[ -n "$dir" ]]; then
    cd "$dir"
  fi
}

[ -f "$HOME/.local/bin/env" ] && source "$HOME/.local/bin/env"

if [[ -z "$TMUX" ]]; then
  if tmux has-session -t main 2>/dev/null; then
    tmux attach-session -t main
  else
    tmux new-session -s main
  fi
fi

export PATH="$HOME/.local/bin:$PATH"

# --------------------
# Финальная инициализация
# --------------------
zinit cdreplay -q
# Отключаем тему OMZ (::ys) – используем Starship вместо неё
# zinit snippet OMZ::themes/ys.zsh-theme

# Инициализация Starship prompt
eval "$(starship init zsh)"

# ================================================================
# Конец файла .zshrc
# ================================================================
# ~/.zshrc

# Функция-заместитель для nvim
nvim() {
  # Если нет аргументов — просто запускаем
  if [ $# -eq 0 ]; then
    command nvim
    return
  fi

  # Проверяем первый аргумент (файл)
  local file="$1"
  # Если файл не существует или у нас есть на него право на запись — нормальный запуск
  if [ ! -e "$file" ] || [ -w "$file" ]; then
    command nvim "$@"
  else
    # Иначе запускаем под sudo, сохраняя окружение (-E) для того,
    # чтобы vim взял вашу конфигурацию из $HOME/.config/nvim
    sudo -E nvim "$@"
  fi
}
# HP Mini Syncthing Server
alias hpssh="ssh mflkee@192.168.1.124"
alias hpgui="ssh -N -L 9999:127.0.0.1:8384 mflkee@192.168.1.124"

