{{- if eq .chezmoi.os "linux" -}}
#!/bin/bash
set -euo pipefail

LOGFILE="/tmp/run_once_install_done.log"

if [ -f "$LOGFILE" ]; then
    echo "‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —É–∂–µ –±—ã–ª–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —Ä–∞–Ω–µ–µ. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º."
    exit 0
fi

exec > >(tee -i "/tmp/run_once_install_$(date +%Y%m%d_%H%M%S).log")
exec 2>&1

echo "üîÑ [$(date +%T)] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã..."
yay -Syu --noconfirm || {
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–∏—Å—Ç–µ–º—ã"
    exit 1
}

install_yay() {
    if ! command -v yay &>/dev/null; then
        echo "üõ†Ô∏è [$(date +%T)] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ yay..."
        tmp_dir=$(mktemp -d)
        git clone https://aur.archlinux.org/yay.git "$tmp_dir"
        (cd "$tmp_dir" && makepkg -si --noconfirm)
        rm -rf "$tmp_dir"
    fi
}
install_yay

install_all() {
    echo "üì¶ [$(date +%T)] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–æ–≤: $*"
    yay -S --noconfirm --needed "$@" || {
        echo "‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–∞–∫–µ—Ç–æ–≤: $*"
        exit 1
    }
}

if [[ -f ./extra_packages.txt ]]; then
    mapfile -t extra_pkgs < ./extra_packages.txt
    install_all "${extra_pkgs[@]}"
fi

if [[ -f ./aur_packages.txt ]]; then
    mapfile -t aur_pkgs < ./aur_packages.txt
    install_all "${aur_pkgs[@]}"
fi

setup_keyboard() {
    echo "‚å®Ô∏è [$(date +%T)] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞—Å–∫–ª–∞–¥–∫–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã..."
    sudo localectl set-x11-keymap --no-convert us,ru pc105 "" grp:alt_shift_toggle
}
setup_keyboard

setup_tmux() {
    echo "üßµ [$(date +%T)] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ tmux..."
    install_all tmux
    [ -d ~/.tmux/plugins/tpm ] || git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
}
setup_tmux

setup_zsh() {
    echo "üíª [$(date +%T)] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Zsh..."
    ZSH="${ZSH:-$HOME/.oh-my-zsh}"
    if [ ! -d "$ZSH" ]; then
        sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
    fi

    ZSH_CUSTOM="${ZSH_CUSTOM:-$ZSH/custom}"
    plugins=(
        https://github.com/zsh-users/zsh-syntax-highlighting.git
    )

    for plugin in "${plugins[@]}"; do
        repo_name=$(basename "$plugin" .git)
        if [ ! -d "$ZSH_CUSTOM/plugins/$repo_name" ]; then
            git clone "$plugin" "$ZSH_CUSTOM/plugins/$repo_name"
        fi
    done

    if ! grep -q "zsh-syntax-highlighting.zsh" ~/.zshrc; then
        echo 'source $ZSH_CUSTOM/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh' >> ~/.zshrc
    fi
}
setup_zsh

setup_sudo() {
    echo "üîí [$(date +%T)] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ sudo –¥–ª—è Wi-Fi..."
    echo '%network ALL=(ALL) NOPASSWD: /sbin/nmcli radio wifi off, /sbin/nmcli radio wifi on' | \
        sudo tee /etc/sudoers.d/network-wifi >/dev/null
    sudo chmod 440 /etc/sudoers.d/network-wifi
}
setup_sudo

echo "üé® [$(date +%T)] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —à—Ä–∏—Ñ—Ç–æ–≤..."
sudo fc-cache -fv

touch "$LOGFILE"

echo "‚úÖ [$(date +%T)] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
{{- end -}}
