#!/usr/bin/env bash
set -euo pipefail

log() {
  printf '[chezmoi-auto-timezone] %s\n' "$*" >&2
}

require() {
  if ! command -v "$1" >/dev/null 2>&1; then
    log "missing dependency: $1"
    exit 1
  fi
}

require sudo
require curl
require timedatectl

script_path="/usr/local/bin/update-timezone-from-ip"
service_path="/etc/systemd/system/update-timezone.service"
timer_path="/etc/systemd/system/update-timezone.timer"

tmp_script=$(mktemp)
tmp_service=$(mktemp)
tmp_timer=$(mktemp)
trap 'rm -f "$tmp_script" "$tmp_service" "$tmp_timer"' EXIT

cat >"${tmp_script}" <<'SCRIPT'
#!/usr/bin/env bash
set -euo pipefail

log() {
  printf '[update-timezone] %s\n' "$*" >&2
}

require() {
  if ! command -v "$1" >/dev/null 2>&1; then
    log "missing dependency: $1"
    exit 1
  fi
}

require curl
require timedatectl

current_tz=$(timedatectl show -p Timezone --value 2>/dev/null || true)

CONFIG_FILE=${CONFIG_FILE:-/etc/update-timezone.conf}
if [[ -f "$CONFIG_FILE" ]]; then
  # shellcheck disable=SC1090
  source "$CONFIG_FILE"
fi

disable_flag="${DISABLE_UPDATE_TIMEZONE:-${DISABLED:-false}}"
case "${disable_flag,,}" in
  1|true|yes|on)
    log "update disabled via config"
    exit 0
    ;;
esac

allowed_list="${ALLOWED_TIMEZONES:-}"
default_tz="${DEFAULT_TIMEZONE:-}"
[[ -z "$default_tz" ]] || default_tz=${default_tz//$'\r'/}
[[ -z "$allowed_list" ]] || allowed_list=${allowed_list//$'\r'/}

fetch_ipapi() {
  if ! data=$(curl -fsSL "https://ipapi.co/timezone" 2>/dev/null); then
    return 1
  fi
  data=${data//$'\r'/}
  if [[ -n "$data" && "$data" != null ]]; then
    printf '%s' "$data"
    return 0
  fi
  return 1
}

fetch_ipwho() {
  if ! data=$(curl -fsSL "https://ipwho.is/" 2>/dev/null); then
    return 1
  fi
  tz=$(printf '%s\n' "$data" | sed -n 's/.*"timezone" *: *{[^}]*"id" *: *"\([^"]*\)".*/\1/p')
  if [[ -n "$tz" && "$tz" != null ]]; then
    printf '%s' "$tz"
    return 0
  fi
  return 1
}

try_sources() {
  local tz
  for source in fetch_ipapi fetch_ipwho; do
    if tz=$($source 2>/dev/null); then
      if timedatectl list-timezones 2>/dev/null | grep -Fxq "$tz"; then
        printf '%s' "$tz"
        return 0
      else
        log "source $source returned unknown timezone '$tz'"
      fi
    else
      log "source $source failed"
    fi
  done
  return 1
}

if ! new_tz=$(try_sources); then
  if [[ -n "$default_tz" ]]; then
    new_tz="$default_tz"
    log "no timezone found; falling back to ${new_tz}"
  else
    log "no timezone found"
    exit 1
  fi
fi

check_allowed() {
  local candidate="$1"
  if [[ -z "$allowed_list" ]]; then
    return 0
  fi

  while read -r entry; do
    [[ -z "$entry" ]] && continue
    if [[ "$entry" == "$candidate" ]]; then
      return 0
    fi
  done <<<"$allowed_list"

  return 1
}

if ! check_allowed "$new_tz"; then
  log "timezone ${new_tz} not in allowed list"
  if [[ -n "$default_tz" ]]; then
    if check_allowed "$default_tz"; then
      new_tz="$default_tz"
      log "falling back to ${new_tz}"
    else
      log "default timezone ${default_tz} also not allowed; aborting"
      exit 1
    fi
  else
    log "no default timezone configured; aborting"
    exit 1
  fi
fi

if [[ "$new_tz" == "$current_tz" ]]; then
  log "timezone already ${current_tz}"
  exit 0
fi

log "setting timezone to ${new_tz}"
timedatectl set-timezone "$new_tz"
log "timezone updated (previously ${current_tz:-unknown})"
SCRIPT

cat >"${tmp_service}" <<'SERVICE'
[Unit]
Description=Update system timezone from IP geolocation
After=network-online.target
Wants=network-online.target

[Service]
Type=oneshot
ExecStart=/usr/local/bin/update-timezone-from-ip

[Install]
WantedBy=multi-user.target
SERVICE

cat >"${tmp_timer}" <<'TIMER'
[Unit]
Description=Periodic timezone update from IP geolocation

[Timer]
OnBootSec=5min
OnUnitActiveSec=1h
AccuracySec=10min
Persistent=true
Unit=update-timezone.service

[Install]
WantedBy=timers.target
TIMER

config_path="/etc/update-timezone.conf"

if [[ ! -f "$config_path" ]]; then
  log "Writing default config to ${config_path}"
  sudo tee "$config_path" >/dev/null <<'CONF'
# Configuration for update-timezone-from-ip
# Uncomment and adjust the values to constrain automatic timezone updates.

# Space or newline separated list of timezones that are allowed to be set.
# If empty, any timezone returned by the providers may be applied.
#ALLOWED_TIMEZONES="Asia/Yakutsk"

# Fallback timezone used when providers fail or return a disallowed value.
#DEFAULT_TIMEZONE="Asia/Yakutsk"

# Set to true to disable automatic updates entirely.
#DISABLE_UPDATE_TIMEZONE=false
CONF
else
  log "Config ${config_path} already exists; leaving untouched"
fi

log "Installing ${script_path}"
sudo install -Dm755 "${tmp_script}" "${script_path}"

log "Installing ${service_path}"
sudo install -Dm644 "${tmp_service}" "${service_path}"

log "Installing ${timer_path}"
sudo install -Dm644 "${tmp_timer}" "${timer_path}"

log "Reloading systemd units"
sudo systemctl daemon-reload

if sudo systemctl enable --now update-timezone.timer >/dev/null 2>&1; then
  log "update-timezone.timer enabled"
else
  log "failed to enable update-timezone.timer"
fi

log "Triggering immediate timezone update"
sudo systemctl start update-timezone.service

log "Timezone auto-update configured"
